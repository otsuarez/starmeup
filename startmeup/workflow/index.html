<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">

        <title>workflow - Doc</title>

        <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../css/font-awesome-4.0.3.css" rel="stylesheet">
        <link href="../../css/prettify-1.0.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>

            <!-- Main title -->
            <a class="navbar-brand" href="../..">Doc</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            <!-- Main navigation -->
            <ul class="nav navbar-nav">
            
            
                <li class="dropdown active">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">startmeup <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li class="active">
                            <a href=".">workflow</a>
                        </li>
                    
                    </ul>
                </li>
            
            
            
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">release <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li >
                            <a href="../../release/readme">readme</a>
                        </li>
                    
                        <li >
                            <a href="../../release/alfa">alfa</a>
                        </li>
                    
                        <li >
                            <a href="../../release/make-deploy-stdout">deploy stdout</a>
                        </li>
                    
                    </ul>
                </li>
            
            
            
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">aptly <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li >
                            <a href="../../aptly/workflow">workflow</a>
                        </li>
                    
                        <li >
                            <a href="../../aptly/commands">commands</a>
                        </li>
                    
                        <li >
                            <a href="../../aptly/setup">setup</a>
                        </li>
                    
                        <li >
                            <a href="../../aptly/gpg-keys">GPG Keys</a>
                        </li>
                    
                    </ul>
                </li>
            
            
            
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">howto <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li >
                            <a href="../../howto/vagrant-lxc">vagrant-lxc</a>
                        </li>
                    
                        <li >
                            <a href="../../howto/vagrant-hostmanager">hostmanager</a>
                        </li>
                    
                        <li >
                            <a href="../../howto/apidocs">api doc</a>
                        </li>
                    
                    </ul>
                </li>
            
            
            
                <li >
                    <a href="../../about">About</a>
                </li>
            
            
            </ul>

            <!-- Search, Navigation and Repo links -->
            <ul class="nav navbar-nav navbar-right">
                
                <li >
                    <a rel="next" href="../..">
                        <i class="fa fa-arrow-left"></i> Previous
                    </a>
                </li>
                <li >
                    <a rel="prev" href="../../release/readme">
                        Next <i class="fa fa-arrow-right"></i>
                    </a>
                </li>
                
            </ul>
        </div>
    </div>
</div>

        <div class="container">
            <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="main active"><a href="#tldr">tl;dr</a></li>
        
    
        <li class="main "><a href="#options">Options</a></li>
        
    
        <li class="main "><a href="#option-a">Option A</a></li>
        
            <li><a href="#create-package-stage">create package stage</a></li>
        
            <li><a href="#deploy-package-stage">deploy package stage</a></li>
        
    
        <li class="main "><a href="#jenkins-team-server">jenkins team server</a></li>
        
    
        <li class="main "><a href="#jenkins-main-server">jenkins main server</a></li>
        
    
        <li class="main "><a href="#setup">setup</a></li>
        
            <li><a href="#jenkins-nodes">jenkins nodes</a></li>
        
    
        <li class="main "><a href="#semver-service">semver service</a></li>
        
    
        <li class="main "><a href="#variables">Variables</a></li>
        
            <li><a href="#pool_name">pool_name</a></li>
        
    
    </ul>
</div></div>
            <div class="col-md-9" role="main">

<h1 id="tldr">tl;dr</h1>
<ul>
<li>create workspace on remote node (datacenter/server)</li>
<li>clone startmeup repository in <code>/home/local/git</code> on remote node</li>
<li>create node in main jenkins server</li>
<li>create Deploy_Package_<remote_node>  job in main jenkins server</li>
<li>Add Deploy_Package_<remote_node> to Deploy_Package  job in main jenkins server</li>
<li>modify build job to grab version number from semver service</li>
<li>create semver service</li>
</ul>
<h1 id="options">Options</h1>
<p>there's plan A which consists in replicating the current setup as it is.</p>
<p>items</p>
<ul>
<li>jenkins</li>
<li>ansible playbooks</li>
</ul>
<p>Pros</p>
<ul>
<li>proven solution (working solution)</li>
<li>quick setup (just copy/paste, no workflow logic)</li>
</ul>
<p>Cons</p>
<ul>
<li>limited scalability (works best at scale of one: one process, one job, one server)</li>
<li>domino architecture (see before). each individual step triggers the next one as it a domino fall.</li>
<li>limited workflow logic (sequential one)</li>
</ul>
<p>There's a plan b which would consists on creating a descentralized, distributed architecture.</p>
<p>items</p>
<ul>
<li>jenkins</li>
<li>ansible playbooks</li>
<li>rundeck</li>
<li>queue manager</li>
<li>workers</li>
</ul>
<p>Pros</p>
<ul>
<li>scalable</li>
<li>easier to administer resources</li>
<li>performance</li>
<li>faster execution/deployments</li>
</ul>
<p>Cons</p>
<ul>
<li>requires a bit of planning</li>
<li>more tools involved</li>
</ul>
<h1 id="option-a">Option A</h1>
<p>mimic current setup but deploying native packages</p>
<h2 id="create-package-stage">create package stage</h2>
<pre class="prettyprint well"><code>build_package (@team jenkins server)
--- (triggers) ---&gt; create_package (@jenkins main server)
--- (triggers) ---&gt; ansible playbook startmeup/package  (@jenkins main server)
</code></pre>

<h2 id="deploy-package-stage">deploy package stage</h2>
<p>--- (triggers) ---&gt;
Deploy_Package (@jenkins main server)
implement bash-based logic and
--- (triggers) ---&gt; Deploy_Package_<environment_name></p>
<ul>
<li>install startmeup code in /home/local/git/startmeup for each nms (datacenter/server)</li>
<li>add the nms/server to the UPDATE_GIT_REPOS job.</li>
<li>create a jenkins node for each environment</li>
<li>create a jenkins job for deploying on each environment attached to the correspondig node</li>
</ul>
<p>crear jenkins jobs for each environment deploying package</p>
<p>total de jobs = #envrs + 1
playbooks</p>
<p>http://newsletter.lanoticia1.com/user/reset/1/1414074488/fn3wz6jd4xDsmFdYedAlR6Kn_7O9h8xJVbwdV3oaUCE/login</p>
<hr />
<pre class="prettyprint well"><code>@create package
BRANCH=origin/master
SEMVER=puppet-1.0.67
SHA=eedcce6f145ae8a18b4846716381910a5b0e4a3f

bash  create_package.sh ${SEMVER}-$(echo $BRANCH | cut -f2 -d\/)-$(echo $SHA | cut -c 1-7).zip
rls@acme-dc-privatecloud-nms $ ping dev3-core-server
PING dev3-core-be (192.168.0.23) 56(84) bytes of data.
</code></pre>

<p>@nms
playbook</p>
<pre class="prettyprint well"><code>make deploy name=${NAME} version=${VERSION} app=${APP}
</code></pre>

<hr />
<p>deploy</p>
<p>paquete -&gt; where to deploy it (server/dc) hostname based directory for inventory</p>
<p>armar api en elvira/octopush
hum....
no hace falta condicionales
creastes paquete -&gt; lo deployastes automaticamente
solo hay que definir el ambiente y ahi se ejecuta el make deploy ....</p>
<p>create_package -&gt; deploy_package (logica de deploy) -&gt; deploy_package_datacenter</p>
<h1 id="jenkins-team-server">jenkins team server</h1>
<pre class="prettyprint well"><code>BRANCH=${GIT_BRANCH}
SHA=${GIT_COMMIT}
SEMVER=${PROJECT}-1.0.${BUILD_NUMBER}
JOB_URL=http://jenkins.acme.com/job/Create_Package/
JENKINS_USER=jenkins-rls
API_TOKEN=xxxxxxx
# Start the build
curl --user $JENKINS_USER:$API_TOKEN &quot;$JOB_URL/buildWithParameters?SHA=${SHA}&amp;SEMVER=${SEMVER}&amp;BRANCH=${BRANCH}&quot;
</code></pre>

<h1 id="jenkins-main-server">jenkins main server</h1>
<pre class="prettyprint well"><code>bash  create_package.sh ${SEMVER}-$(echo $BRANCH | cut -f2 -d\/)-$(echo $SHA | cut -c 1-7).zip
</code></pre>

<blockquote>
<p>create_package.sh</p>
</blockquote>
<pre class="prettyprint well"><code>. ~/.bash_profile

# nasty hack for the ABL package ;)
#SHORT_SHA=$(echo $SHA | cut -c 1-7)
if echo $SHA | fgrep -q &quot;-&quot;
then
  SHORT_SHA=${SHA}
else
  SHORT_SHA=$(echo $SHA | cut -c 1-7)
fi

# nasty hack for smaug package ;)
#COMPONENT=$(echo ${SEMVER} | sed 's/\(.*\)-\([0-9]\+\.[0-9]\+\.[0-9]\+\)/\1/')
#VERSION=$(echo ${SEMVER} | sed 's/\(.*\)-\([0-9]\+\.[0-9]\+\.[0-9]\+\)/\2/')
if echo $SEMVER | fgrep -q &quot;smaug&quot;
then
  COMPONENT=$(echo ${SEMVER} | sed 's/\(.*\)-\([0-9]\+\)/\1/')
  VERSION=$(echo ${SEMVER} | sed 's/\(.*\)-\([0-9]\+\)/\2/')
else
  COMPONENT=$(echo ${SEMVER} | sed 's/\(.*\)-\([0-9]\+\.[0-9]\+\.[0-9]\+\)/\1/')
  VERSION=$(echo ${SEMVER} | sed 's/\(.*\)-\([0-9]\+\.[0-9]\+\.[0-9]\+\)/\2/')
fi

GIT_BRANCH=$(echo $BRANCH | cut -f2 -d\/)
FILENAME=${SEMVER}-${GIT_BRANCH}-${SHORT_SHA}.zip
#echo &quot;component=${COMPONENT} version=${VERSION} filename=octopush-1.0.269-master-646a561.zip branch=${GIT_BRANCH} sha=${SHORT_SHA}&quot;
cd /home/local/git/startmeup/package
echo &quot;ansible-playbook -i inventory main.yml -e \&quot;component=${COMPONENT} version=${VERSION} filename=${FILENAME} branch=${GIT_BRANCH} sha=${SHORT_SHA}\&quot;&quot;
ansible-playbook -i inventory main.yml -e &quot;component=${COMPONENT} version=${VERSION} filename=${FILENAME} branch=${GIT_BRANCH} sha=${SHORT_SHA}&quot;
</code></pre>

<p>ssh config for jenkins user to access datacenters as rls user</p>
<pre class="prettyprint well"><code>Host dev3-core-server
    Hostname 192.168.0.23
    User rls
    IdentityFile ~/.ssh/keys/id_acme-rls_jenkins_rsa
    StrictHostKeyChecking no
Host octopush-dev
  User rls
  Hostname 10.1.2.210
  ServerAliveInterval 300
  ServerAliveCountMax 60
  StrictHostKeyChecking no
  ProxyCommand ssh dev3-core-server nc %h %p -w 10 2&gt; /dev/null
  IdentityFile ~/.ssh/keys/id_acme-rls_jenkins_rsa

Host *
    User rls
    IdentityFile ~/.ssh/keys/id_acme-rls_jenkins_rsa
    StrictHostKeyChecking no
</code></pre>

<h1 id="setup">setup</h1>
<p>The deployment of packages will be triggered by the main jenkins server. There will be a job which</p>
<h2 id="jenkins-nodes">jenkins nodes</h2>
<p>@remote node</p>
<p>Create workspace</p>
<p>sudo mkdir /opt/jenkins
sudo chown rls:users /opt/jenkins -R</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>Name</td>
<td>dev3-core-as-rls-user</td>
<td>name of the remote node</td>
</tr>
<tr>
<td>Description</td>
<td>dev3-core-server</td>
<td>Optional human-readable description of this slave.</td>
</tr>
<tr>
<td>Remote FS root</td>
<td>/opt/jenkins</td>
<td>A directory dedicated to Jenkins. Specify the absolute path of this work directory on the remote node. It should be created and owned by the user connecting via ssh</td>
</tr>
<tr>
<td>Labels</td>
<td>dev3-core-server</td>
<td>Labels (AKA tags) are used for grouping multiple slaves into one logical group.</td>
</tr>
<tr>
<td>Usage</td>
<td>Leave this machine for tied jobs only</td>
<td>In this mode, Jenkins will only build a project on this machine when that project specifically has this slave as the "assigned node".</td>
</tr>
<tr>
<td>Launch method</td>
<td>Launch slave agents on Unix machines via SSH</td>
<td>Controls how Jenkins starts this slave.</td>
</tr>
<tr>
<td>Host</td>
<td>dev3-core-server</td>
<td>remote hostname, should already be configured on the jenkins user ssh config</td>
</tr>
<tr>
<td>Availability</td>
<td>Keep this slave on-line as much as possible</td>
<td>This is the default and normal setting.</td>
</tr>
</tbody>
</table>
<blockquote>
<p>Note: add hostname/ip in /etc/hosts in main jenkins server
ssh from jenkins doesn't read ~/.ssh/config configuration.</p>
</blockquote>
<hr />
<h1 id="semver-service">semver service</h1>
<p>A REST API service which will return a semver version number for a given package number and git branch.</p>
<p>semver server para octopush</p>
<ul>
<li>modificar build job to grab semver from elvira</li>
</ul>
<p>https://gist.github.com/guerremdq/2b59d0d43e7c6c7b57f8
https://github.com/ravibhure/ansible-modules-extras/blob/db77cff31d1b01db163472cf6320019392bcc842/net_infrastructure/haproxy.py
http://localhost/haproxy?stats#localpool/web1
https://github.com/flores/haproxyctl
http://localhost:8500/ui/#/dc1/kv/
http://acme-dot-io.github.io/startmeup/
http://jenkins.acme.com/job/Deploy_Package/configure
http://localhost:8000/startmeup/workflow/</p>
<h1 id="variables">Variables</h1>
<h2 id="pool_name">pool_name</h2>
<p>packages/group-vars/common-<component_name>.yml</p>
<pre class="prettyprint well"><code># deploy playbook
pool_name: web
</code></pre>

</div>
        </div>

        

        <script src="https://code.jquery.com/jquery-1.10.2.min.js"></script>
        <script src="../../js/bootstrap-3.0.3.min.js"></script>
        <script src="../../js/prettify-1.0.min.js"></script>
        <script src="../../js/base.js"></script>
    </body>
</html>